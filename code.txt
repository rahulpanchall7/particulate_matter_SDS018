main.c

/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "sds011.h"
/* USER CODE END Includes */



/* Private variables ---------------------------------------------------------*/
UART_HandleTypeDef huart1;
UART_HandleTypeDef huart2;

/* USER CODE BEGIN PV */
SDS sds;

uint8_t data[50];
uint16_t size = 0;
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_USART2_UART_Init(void);
static void MX_USART1_UART_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */



int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

	/* Initialize all configured peripherals */
	MX_GPIO_Init();
	MX_USART2_UART_Init();
	MX_USART1_UART_Init();
	/* USER CODE BEGIN 2 */
	sdsInit(&sds, &huart1);
	/* USER CODE END 2 */
	/* Infinite loop */
	/* USER CODE BEGIN WHILE */
	while (1) {
		size = sprintf(data, "%d %d \n\r", sdsGetPm2_5(&sds), sdsGetPm10(&sds));
		HAL_UART_Transmit_IT(&huart2, data, size);
		HAL_Delay(1000);
		/* USER CODE END WHILE */

		/* USER CODE BEGIN 3 */
	}
	/* USER CODE END 3 */
}


/* USER CODE BEGIN 4 */
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
sds_uart_RxCpltCallback(&sds,huart);
}
/* USER CODE END 4 */





















sds011

/*
 * sds011.c
 *
 *  Created on: 10.03.2019
 *      Author: SimpleMethod
 *
 *Copyright 2019 SimpleMethod
 *
 *Permission is hereby granted, free of charge, to any person obtaining a copy of
 *this software and associated documentation files (the "Software"), to deal in
 *the Software without restriction, including without limitation the rights to
 *use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 *of the Software, and to permit persons to whom the Software is furnished to do
 *so, subject to the following conditions:
 *
 *The above copyright notice and this permission notice shall be included in all
 *copies or substantial portions of the Software.
 *
 *THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *THE SOFTWARE.
******************************************************************************
*/


#include "sds011.h"

/**
 * UART settings:
 *
 * Baud Rate: 9600 Bits/s
 *
 * Word Length: 8 Bits
 *
 * Parity None
 *
 * Stop Bits 1
 *
 * Enable NVIC global interrupt!
 *
 */


/**
 *   Library initialization.
 *
 *   @param sds pointer to SDS_t handle structure
 *   @param huart_sds pointer to UART handle structure
*/
void sdsInit(SDS* sds, const UART_HandleTypeDef* huart_sds)
{
sds->huart_sds=(UART_HandleTypeDef *)huart_sds;
HAL_UART_Transmit(sds->huart_sds,(uint8_t*)Sds011_WorkingMode, 19,30);
HAL_UART_Receive_IT(sds->huart_sds, sds->data_receive, 10);
}



/**
 *   Calculation of the checksum
 *
 *   @param buff array with a message to send to the device
 *   @return calculated checksum
*/
uint8_t getCRC(uint8_t buff[]) {
  uint8_t crc = 0;
  for (uint8_t i = 2; i < 17; ++i) {
    crc += buff[i];
  }
  return crc;
}


/**
 *   Enter the device into sleep mode
 *
 *   @param sds pointer to SDS_t handle structure
 *   @return status of the message transmission
*/
int8_t sdsSleepMode(SDS* sds)
{
	return HAL_UART_Transmit(sds->huart_sds, (uint8_t*)Sds011_SleepCommand,19,30)==HAL_OK ? 1:0;
}

/**
 *  Enter the device into working mode
 *
 *   @param sds pointer to SDS_t handle structure
 *   @return status of the message transmission
*/
int8_t sdsWorkingMode(SDS* sds)
{
	return HAL_UART_Transmit(sds->huart_sds, (uint8_t*)Sds011_WorkingMode,19,30)==HAL_OK ? 1:0;
}

/**
 *   Send any message to the device
 *
 *   @param sds pointer to SDS_t handle structure
 *   @param data_buffer array with a message to send to the device
 *   @param message length
 *   @return status of the message transmission
*/
int8_t sdsSend(SDS* sds, const uint8_t* data_buffer, const uint8_t length)
{
	return HAL_UART_Transmit(sds->huart_sds,(uint8_t *) data_buffer,length,30)==HAL_OK ? 1:0;
}

/**
 *   Getting the value of PM 2.5
 *
 *   @param sds pointer to SDS_t handle structure
 *   @return value of PM 2.5
*/
uint16_t sdsGetPm2_5(SDS* sds)
{
	return  sds->pm_2_5;
}

/**
 *   Getting the value of PM 10
 *
 *   @param sds pointer to SDS_t handle structure
 *   @return value of PM 10
*/
uint16_t sdsGetPm10(SDS* sds)
{
	return  sds->pm_10;
}

/**
 *   UART Rx Complete Callback
 *
 *   @param sds pointer to SDS_t handle structure
 *   @param huart pointer to UART handle structure
*/
void sds_uart_RxCpltCallback(SDS* sds, UART_HandleTypeDef *huart)
{
	if(huart == sds->huart_sds)
		{
				if((sds->data_receive[1] == 0xC0))
				{
					sds->pm_2_5 = ((sds->data_receive[3]<<8)| sds->data_receive[2])/10;
					sds->pm_10 = ((sds->data_receive[5]<<8)| sds->data_receive[4])/10;
			}
			HAL_UART_Receive_IT(sds->huart_sds, sds->data_receive, 10);
		}
}









sds011.h
/*
 * sds011.h
 *
 *  Created on: 10.03.2019
 *      Author: SimpleMethod
 *
 *Copyright 2019 SimpleMethod
 *
 *Permission is hereby granted, free of charge, to any person obtaining a copy of
 *this software and associated documentation files (the "Software"), to deal in
 *the Software without restriction, including without limitation the rights to
 *use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 *of the Software, and to permit persons to whom the Software is furnished to do
 *so, subject to the following conditions:
 *
 *The above copyright notice and this permission notice shall be included in all
 *copies or substantial portions of the Software.
 *
 *THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *THE SOFTWARE.
******************************************************************************
*/

#ifndef INC_SDS011_H_
#define INC_SDS011_H_

#include "stm32f4xx_hal.h"


typedef struct SDS_t {
  UART_HandleTypeDef* huart_sds;
  uint16_t pm_2_5;
  uint16_t  pm_10;
  uint8_t data_receive[19];
} SDS;


static const uint8_t Sds011_SleepCommand[] = {
		0xAA,
		0xB4,
		0x06,
		0x01,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0xFF,
		0xFF,
		0x05,
		0xAB
};

static const uint8_t Sds011_WorkingMode[] = {
		0xAA,
		0xB4,
		0x06,
		0x01,
		0x01,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0xFF,
		0xFF,
		0x06,
		0xAB
};


void sdsInit(SDS* sds, const UART_HandleTypeDef* huart_sds);
void sds_uart_RxCpltCallback(SDS* sds, UART_HandleTypeDef *huart);

int8_t sdsSend(SDS* sds, const uint8_t *data_buffer, const uint8_t length);

uint16_t sdsGetPm2_5(SDS* sds);
uint16_t sdsGetPm10(SDS* sds);

int8_t sdsWorkingMode(SDS* sds);
int8_t sdsSleepMode(SDS* sds);

uint8_t getCRC(uint8_t buff[]);


#endif /* SDS011_H_ */








